{% extends "base.html" %}

{% block title %}Analytics{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="bi bi-bar-chart"></i> Analytics
        </h2>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Task Completion Rate</h5>
            </div>
            <div class="card-body">
                <canvas id="completionChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Time by Category</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recent Time Logs</h5>
            </div>
            <div class="card-body">
                <div id="time-logs-container">
                    <p class="text-muted">Loading time logs...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    let completionChart, categoryChart;
    
    async function loadAnalytics() {
        try {
            const response = await fetch('/api/analytics/summary');
            const data = await response.json();
            
            // Completion Chart
            const completionCtx = document.getElementById('completionChart').getContext('2d');
            if (completionChart) completionChart.destroy();
            
            completionChart = new Chart(completionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'In Progress', 'Pending'],
                    datasets: [{
                        data: [
                            data.completed_tasks,
                            data.in_progress_tasks,
                            data.pending_tasks
                        ],
                        backgroundColor: ['#198754', '#ffc107', '#6c757d']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();
            
            categoryChart = new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: data.category_breakdown.map(c => c.category),
                    datasets: [{
                        label: 'Hours',
                        data: data.category_breakdown.map(c => c.time),
                        backgroundColor: '#0d6efd'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading analytics:', error);
        }
    }
    
    async function loadTimeLogs() {
        try {
            const response = await fetch('/api/timelogs?user_id={{ current_user.id }}');
            const logs = await response.json();
            
            const container = document.getElementById('time-logs-container');
            
            if (logs.length === 0) {
                container.innerHTML = '<p class="text-muted">No time logs yet</p>';
                return;
            }
            
            // Get task details for each log
            const logsWithTasks = await Promise.all(
                logs.slice(0, 10).map(async log => {
                    const taskResponse = await fetch(`/api/tasks/${log.task_id}`);
                    const task = await taskResponse.json();
                    return { ...log, task };
                })
            );
            
            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Duration (hrs)</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${logsWithTasks.map(log => `
                                <tr>
                                    <td>${log.task.title}</td>
                                    <td>${new Date(log.start_time).toLocaleString()}</td>
                                    <td>${log.end_time ? new Date(log.end_time).toLocaleString() : 'Active'}</td>
                                    <td>${log.duration ? log.duration.toFixed(2) : '-'}</td>
                                    <td>${log.notes || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } catch (error) {
            console.error('Error loading time logs:', error);
        }
    }
    
    // Load on page load
    loadAnalytics();
    loadTimeLogs();
</script>
{% endblock %}
